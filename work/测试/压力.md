## :pencil2: 压测场景

### http接口测试：

场景会比较简单

小程序一般是几个接口（当时是按照接口算钱的），要测的接口一般是他们给或者我们自己抓包让他们确认。需求：一般是测一下最大TPS、响应时间、最大并发。
压测场景主要分为：单接口场景和混合场景

单接口场景就是对单个接口进行性能压测

混合场景：多个接口按照比例一起压测，其中包含有上下文联动的关系。

并发人数的估算：用户数 --》在线人数--》并发人数 ，每次转化可以使用2/8原则



根据用户要求，设置tps、事务成功率、响应时间基线进行对比，出报告。
对tpc波动、响应超时、错误事务额外关注。



#### TPS下降的原因：

短链接比长链接多一个重建链接，重建链接也需要时间，导致发包变慢了，TPS降低了。

1、网络带宽

在压力测试中，有时候要模拟大量的用户请求，如果单位时间内传递的数据包过大，超过了带宽的传输能力，那么就会造成网络资源竞争，间接导致服务端接收到的请求数达不到服务端的处理能力上限。

2、连接池

可用的连接数太少，造成请求等待。连接池一般分为服务器连接池（比如Tomcat）和数据库连接池（或者理解为最大允许连接数也行）。

3、垃圾回收机制

从常见的应用服务器来说，比如Tomcat，因为java的的堆栈内存是动态分配，具体的回收机制是基于算法，如果新生代的Eden和Survivor区频繁的进行Minor GC，老年代的full GC也回收较频繁，那么对TPS也是有一定影响的，因为垃圾回收其本身就会占用一定的资源。

4、数据库配置

高并发情况下，如果请求数据需要写入数据库，且需要写入多个表的时候，如果数据库的最大连接数不够，或者写入数据的SQL没有索引没有绑定变量，抑或没有主从分离、读写分离等，就会导致数据库事务处理过慢，影响到TPS。

5、通信连接机制

串行、并行、长连接、管道连接等，不同的连接情况，也间接的会对TPS造成影响。

6、硬件资源

包括CPU（配置、使用率等）、内存（占用率等）、磁盘（I/O、页交换等）。

7、压力机

比如jmeter，单机负载能力有限，如果需要模拟的用户请求数超过其负载极限，也会间接影响TPS（这个时候就需要进行分布式压测来解决其单机负载的问题）。

8、压测脚本

还是以jemter举个例子，之前工作中同事遇到的，进行阶梯式加压测试，最大的模拟请求数超过了设置的线程数，导致线程不足。提到这个原因，想表达意思是：有时候测试脚本参数配置等原因，也会影响测试结果。

9、业务逻辑

业务解耦度较低，较为复杂，整个事务处理线被拉长导致的问题。

10、系统架构

比如是否有缓存服务，缓存服务器配置，缓存命中率、缓存穿透以及缓存过期等，都会影响到测试结果。


#### 压力测试TPS上不去，但是系统资源又很清闲

系统瓶颈问题，需要从多方面去考量，遇到瓶颈问题不要遗漏任何一处代码。

从系统层面考量，比如系统参数，内存、CPU分配、网络，IO，带宽；
有瓶颈不一定是业务层代码，也有可能是上游拦截器和AOP的代码，不要遗漏任何一处代码；
遇到问题一定要看日志，日志能说明问题的根本原因；
Java的层面分析问题，不一定是虚拟机的内存问题，还有可能是线程问题；
系统并不是所有操作都是消耗CPU的，有很多场景是不消耗CPU的，比如：阻塞、本地IO和网络IO；
一定要多了解一些监控工具的使用；
同一个机器，部署多个应用也有可能会互相影响，因为此时系统资源耦合的。

端口数耗尽：通过NAT网关配置出口IP往往一开始只配置一个IP，端口数的上限是65535。对于实时通讯的场景来说，需要保持大量的长连接，所以需要提高端口数量。

整体排查思路如下：

1.首先要转变意识，不要停留在单点排查，要有全链路的意识

2.每个环节进行初步排查，看能否快速定位问题

3.实在没有办法，就只能抓包分析了

#### qps

1.QPS（Req/s）随着并发数（Active Threads）的增加不升反降，这说明，一定是某个环节出现了瓶颈，并不能一味的通过增加并发数来提高QPS值。

2.QPS曲线周期性的掉坑又爬上来，就是比较典型的资源耗尽问题。

3.QPS曲线被一刀切下来后平稳的运行，这种就是典型的限频问题。



## 手游压测场景设计

> 在服务器压测过程中，场景设计是非常关键的，直接影响到测试结果是否有效。本文讲述的压测场景设计方案分为两部分：（1）基于游戏后台架构的单场景设计；（2）基于玩家游戏模型的综合场景设计。

### 一、前期准备

**（1）了解服务器架构**

要挑战服务器的压力，就要先了解服务器架构。需要根据服务器的架构来设计一些测试场景，这些场景能够比较极端的测试到每一个单独的服务器，这样的方式可能和实际有一些偏差，因为所有的玩家不可能在同一个时间段都去做一件事情，但是可以更好的帮助我们去定位单台服务器出现的问题。

哪些机器只会做哪些业务、转发操作、数据库、缓存

*在掌握了服务器架构后，尝试解答下面的问题：服务器架构中包含哪些服务？哪些是虚拟服务，哪些服务对应独立的物理机？每个服务在游戏中负责哪些逻辑？*

**（2）熟悉游戏内容和核心玩法**

熟悉游戏的目的在于，分析出哪些场景下可能产生大量的数据交互，数据处理，又或者哪些场景可能是玩家密集区，有哪些核心玩法等等。举个栗子，我在世界聊天中喊一句话，那么这个消息是广播出去的，想象一下如果每一个玩家都在世界频道发送一个消息，这个时候服务器就会存在一定的消息处理的压力。

### 二、场景设计

测试场景的设计通常是从单场景设计和综合场景两个方面入手

**（1）单场景**

单场景更有针对性的发现服务性能问题，是一种基于游戏后台架构的压测方案设计。

Ø 须覆盖到每一个单台服务器的施压，如果是单独负责某一些系统功能的服务器就直接以玩家在该系统的操作场景，如：MailServer；或者选择该服的主逻辑作为测试场景。

Ø 覆盖到游戏的单核心玩法场景，如：匹配，PVP，PVE...，游戏中多数核心业务是单独部署的，这里我们把匹配和战斗相关的协议组合来模拟一个正常的战斗玩法。*相同玩法下尽量选择高并发、多人互动的场景；尽量选择逻辑更复杂的场景*；

**通用参考场景**

Ø 基本场景一般包含：登录，创建角色，聊天，排行榜，邮箱，移动等

Ø 核心玩法：匹配，PVE，PVP，多人混战，家族战等

| **序号** | **场景**                  | **事务/步骤**                                                |
| -------- | ------------------------- | ------------------------------------------------------------ |
| 1        | 登录-全部新号，未创建角色 | 无角色: 登录FL -> 登录 -> 创建 -> 进入场景                   |
|          | 登录-50%无角色+50%有角色  | 有角色：登录FL -> 登录 -> 进入场景                           |
|          | 登录-全部有角色           |                                                              |
| 2        | 聊天                      | 世界聊天，发最大长度文字消息                                 |
| 3        | 交易所                    | 上架物品，物品查询，物品购买                                 |
| 4        | 排行榜                    | 排行榜请求页面—>拉取排行榜—>切换排行榜页                     |
| 5        | 邮件                      | GM服务器下发邮件（邮箱压到上限）—>请求邮件列表（收到下发包）—>随机领取一个—>全部领取（5秒）—>删除一个—>全部删除（5秒） |
| 6        | 装备                      | 装备获取 ->精炼->强化->重铸->镶嵌                            |
| 7        | 家族                      | 登录—>GM升级—>创建家族F（15级最多120人）—>接受申请—>解散家族； 登录—>GM升级—>请求家族列表—>申请加入家族F/一键申请—>退出家族； |
| 8        | 家族战                    | 登录（满足战斗条件）—>切场景—>进战场—>移动/战斗—>结算退出    |
| 9        | 家族守卫战                | 登录—>切换场景—>（家族压满120人）进入守卫战副本—>移动->战斗->结算 |
| 10       | 单人副本PVE（无尽迷宫）   | 登录—>携带装备/载具—>进入副本—>移动—>战—>结算                |
| 11       | 多人副本PVE（治安巡逻）   | 登录—>携带装备/载具—>组队—>进入副本—>移动/战斗—>结算         |
| 12       | PVP—武道会（1V1）         | 登录—>携带装备/载具—>匹配—>进入场景—>移动—>战斗—>结算        |
| 13       | PVP—超次元对决（4V4）     | 登录—>携带装备/载具—>组队/匹配—>进入场景—>移动—>战斗—>结算   |

**（2）综合场景**

综合场景更贴近真实的玩家操作，是一种基于玩家游戏模型的压测方案设计。综合场景的设计方法：（1）监控外网法（推荐）；（2）日志分析法。这里主要介绍了龙珠使用的日志分析方法。

Ø **外网监控法**

外网监控法是一种根据玩家实际发包，来设计机器人场景的方法。

A. 测试期间选择统计外网系统比较平稳后、高峰值时间段的2小时外网玩家数据；

B. 采集玩家发包，统计包量，筛选占总包量90%的动作（或前TOP 10~20动作），作为综合场景的操作。

 *Tips：把难以重复执行的消息（前置条件，时限次限等），用其它等价的消息代替*

Ø **日志分析法**

由于在删档测试期间的时间限制，没有监控到外网玩家数据。开发提供了tlog日志文件，我们通过tlog文件进行分析，提取了其中有参考性的数据，统计整理综合场景中包含的场景及占比。但该过程中仍然包含部分主观推测和数值占比的估算。所以与实际玩家的数据可能存在初入，作为综合场景设计的备选方案。











